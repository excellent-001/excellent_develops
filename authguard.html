<!-- auth-guard.js -->
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { firebaseConfig } from "./firebase-config.js";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
await setPersistence(auth, browserLocalPersistence);

// 60-minute inactivity auto-logout
const LIMIT_MINUTES = 60;
const LS_KEY = "ed_last_active_at";
const setActive = () => localStorage.setItem(LS_KEY, String(Date.now()));
["click","keydown","mousemove","touchstart","scroll"].forEach(evt => window.addEventListener(evt, setActive, {passive:true}));
setInterval(async ()=>{
  const last = Number(localStorage.getItem(LS_KEY) || "0");
  if (last && Date.now() - last > LIMIT_MINUTES*60*1000) {
    try { await signOut(auth); } catch(e){}
    window.location.replace("index.html");
  }
}, 15*1000);
setActive();

onAuthStateChanged(auth, (user)=>{
  if(!user){
    window.location.replace("index.html");
  }
});

// global logout
window.logout = async ()=>{
  try { await signOut(auth); } catch(e){}
  window.location.href = "index.html";
};
