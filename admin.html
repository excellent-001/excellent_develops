<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Control Panel ‚Äî Excellent_Develops</title>

<!-- Chart.js (for simple stats charts) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
  :root{
    --bg:#0b1220; --panel:#121a2b; --card:#0f1727; --ink:#e7eefc; --muted:#9bb0d4;
    --accent:#3b82f6; --accent2:#22c55e; --danger:#ef4444; --warning:#f59e0b;
    --line: #1f2a44;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:radial-gradient(1200px 600px at 10% -10%, #173056 0%, transparent 60%), linear-gradient(180deg,#0b1220 0%,#0b1220 60%, #091120 100%); color:var(--ink); display:flex}
  a{color:inherit;text-decoration:none}
  .sidebar{width:270px;min-width:270px;background:linear-gradient(180deg,#0c1425,#0a1323);border-right:1px solid var(--line);display:flex;flex-direction:column;gap:8px;padding:16px 14px;position:sticky;top:0;height:100vh}
  .brand{display:flex;align-items:center;gap:10px;padding:6px 8px;margin-bottom:8px}
  .brand img{width:28px;height:28px}
  .brand strong{font-size:15px}
  .tag{padding:2px 8px;border:1px solid #ffffff22;border-radius:999px;margin-left:auto;color:var(--muted);font-size:12px}
  .nav-btn{padding:10px 12px;border-radius:10px;border:1px solid transparent;background:#ffffff0a;display:flex;gap:10px;align-items:center;cursor:pointer}
  .nav-btn:hover{background:#ffffff12}
  .nav-btn.active{border-color:#ffffff2a;background:#1b2640}
  .grow{flex:1}
  .danger{color:#ffb4b4}
  .content{flex:1;min-width:0;padding:18px}
  .topbar{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .topbar .chip{padding:4px 10px;border:1px solid #ffffff22;border-radius:999px;background:#ffffff10;color:var(--muted);font-size:12px}
  .btn{border:1px solid #ffffff22;background:#ffffff10;color:var(--ink);padding:10px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:transparent}
  .btn.ghost{background:#ffffff08}
  .btn.small{padding:6px 10px;font-size:13px}
  .grid{display:grid;gap:14px}
  .cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px #0005}
  .pad{padding:16px}
  .title{margin:0 0 8px 0;font-size:18px}
  .muted{color:var(--muted)}
  .stats{display:flex;gap:12px;flex-wrap:wrap}
  .stat{flex:1;min-width:180px;background:linear-gradient(180deg,#101a2e,#0d1628);border:1px solid #203052;border-radius:12px;padding:14px}
  .stat .num{font-size:22px;font-weight:700}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input,select{background:#0b1324;border:1px solid #203052;color:var(--ink);padding:10px 12px;border-radius:10px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px 12px;border-bottom:1px solid #1b2742;vertical-align:top;font-size:14px}
  th{position:sticky;top:0;background:#111a30;z-index:1}
  .pill{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #ffffff20}
  .ok{color:#8cf3b1;background:#10b98122;border-color:#10b98155}
  .bad{color:#ffb3b3;background:#ef444422;border-color:#ef444466}
  .warn{color:#ffd28a;background:#f59e0b22;border-color:#f59e0b55}
  .hidden{display:none !important}
  .login{max-width:420px;margin:8vh auto}
  .login h2{margin-top:6px}
  .footer{color:var(--muted);text-align:center;margin-top:16px;font-size:12px}
  .code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
</style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <img src="https://raw.githubusercontent.com/excellent-001/excellent_develops/refs/heads/main/logo.png" alt="logo">
      <strong>Excellent_Develops</strong>
      <span class="tag">Admin</span>
    </div>

    <button class="nav-btn active" data-section="overview">üìä Overview</button>
    <button class="nav-btn" data-section="traffic">üåç Traffic</button>
    <button class="nav-btn" data-section="feedback">üì© Feedback</button>
    <button class="nav-btn" data-section="projects">üìÅ Project Stats</button>
    <button class="nav-btn" data-section="settings">‚öôÔ∏è Settings</button>
    <button class="nav-btn" data-section="security">üõ°Ô∏è Security</button>

    <div class="grow"></div>

    <div class="muted" id="adminEmail" style="font-size:12px;line-height:1.3"></div>
    <button class="nav-btn danger" id="logoutBtn">üö™ Sign out</button>
  </aside>

  <!-- CONTENT -->
  <main class="content">
    <!-- Topbar -->
    <div class="topbar">
      <div class="chip">Admin Control Panel</div>
      <div class="chip" id="lastUpdated">‚Äî</div>
      <div class="grow"></div>
      <a class="btn small ghost" href="welcome.html">‚Üê Back to site</a>
    </div>

    <!-- Login Gate -->
    <section id="loginGate" class="card pad login">
      <h2>Admin Login</h2>
      <p class="muted">Only approved admin emails can access this page.</p>
      <div class="row" style="flex-direction:column;align-items:stretch">
        <input id="loginEmail" type="email" placeholder="Admin email">
        <input id="loginPass" type="password" placeholder="Password">
        <button id="loginBtn" class="btn primary">Sign in</button>
        <div id="loginErr" class="muted" style="margin-top:8px"></div>
      </div>
      <div class="footer">Tip: Use the same Firebase Auth account as your admin email.</div>
    </section>

    <!-- SECTIONS WRAPPER -->
    <section id="app" class="hidden">

      <!-- OVERVIEW -->
      <section id="section-overview" class="grid">
        <div class="card pad">
          <h3 class="title">Snapshot</h3>
          <div class="stats">
            <div class="stat">
              <div class="muted">Visitors (24h)</div>
              <div class="num" id="statVisitors24h">0</div>
            </div>
            <div class="stat">
              <div class="muted">Total Feedback</div>
              <div class="num" id="statFeedbackTotal">0</div>
            </div>
            <div class="stat">
              <div class="muted">Unique IPs (7d)</div>
              <div class="num" id="statUniqueIPs">0</div>
            </div>
            <div class="stat">
              <div class="muted">Alerts</div>
              <div class="num" id="statAlerts">0</div>
            </div>
          </div>
        </div>

        <div class="card pad">
          <h3 class="title">Visitors ‚Äî last 7 days</h3>
          <canvas id="visitorsChart" height="110"></canvas>
        </div>

        <div class="card pad">
          <h3 class="title">Feedback per project</h3>
          <canvas id="feedbackChart" height="110"></canvas>
        </div>
      </section>

      <!-- TRAFFIC -->
      <section id="section-traffic" class="hidden">
        <div class="card pad">
          <div class="row">
            <h3 class="title" style="margin:0">Traffic Monitor</h3>
            <div class="grow"></div>
            <input id="fIP" placeholder="Filter IP">
            <input id="fISP" placeholder="Filter ISP">
            <input id="fCity" placeholder="Filter City">
            <button id="clearTraffic" class="btn small ghost">Clear</button>
            <button id="exportTraffic" class="btn small">Export CSV</button>
          </div>
        </div>

        <div class="card">
          <table>
            <thead>
              <tr>
                <th>Time (Lagos)</th>
                <th>IP</th>
                <th>ISP</th>
                <th>City</th>
                <th>Region</th>
                <th>Country</th>
                <th>User Agent</th>
                <th>Page</th>
              </tr>
            </thead>
            <tbody id="trafficBody"></tbody>
          </table>
        </div>
      </section>

      <!-- FEEDBACK -->
      <section id="section-feedback" class="hidden">
        <div class="card pad">
          <div class="row">
            <h3 class="title" style="margin:0">Feedback Manager</h3>
            <div class="grow"></div>
            <input id="qEmail" placeholder="Search email">
            <select id="qProject">
              <option value="">All projects</option>
              <option value="excellent">Excellent Global Concept</option>
              <option value="pematech">Pematech Company</option>
              <option value="social">Social Intelligence Hub</option>
              <option value="lms">LMS / Educational</option>
            </select>
            <button id="clearFeedback" class="btn small ghost">Clear</button>
            <button id="exportFeedback" class="btn small">Export CSV</button>
          </div>
        </div>

        <div class="card">
          <table>
            <thead>
              <tr>
                <th>Time (Lagos)</th>
                <th>Project</th>
                <th>Name</th>
                <th>Email</th>
                <th>Topic</th>
                <th>Message</th>
                <th>IP / ISP / City</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="feedbackBody"></tbody>
          </table>
        </div>
      </section>

      <!-- PROJECTS -->
      <section id="section-projects" class="hidden grid cols-2">
        <div class="card pad">
          <h3 class="title">Project Clicks (from projects.html)</h3>
          <canvas id="projectClicks" height="130"></canvas>
          <p class="muted" style="margin-top:8px">This chart uses the optional <span class="code">project_clicks</span> collection if you log clicks. Otherwise it‚Äôll just show zeros until enabled.</p>
        </div>

        <div class="card pad">
          <h3 class="title">Recent Activity</h3>
          <div id="recentActivity" class="muted">‚Äî</div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="section-settings" class="hidden grid cols-2">
        <div class="card pad">
          <h3 class="title">Email Alerts</h3>
          <p class="muted">When this is on, new feedback will also be sent to your inbox via EmailJS (this already happens on the public feedback form; this switch lets the admin panel re-send manually if needed).</p>
          <div class="row">
            <button id="testEmail" class="btn">Send test email</button>
          </div>
        </div>

        <div class="card pad">
          <h3 class="title">Admin Whitelist</h3>
          <p class="muted">Only the emails listed in code can open this page. Current admin(s):</p>
          <ul id="adminList" class="muted" style="margin-top:6px"></ul>
        </div>
      </section>

      <!-- SECURITY -->
      <section id="section-security" class="hidden">
        <div class="card pad">
          <div class="row">
            <h3 class="title" style="margin:0">Security Logs</h3>
            <div class="grow"></div>
            <button id="exportSecurity" class="btn small">Export CSV</button>
          </div>
        </div>
        <div class="card">
          <table>
            <thead>
            <tr>
              <th>Time (Lagos)</th>
              <th>Event</th>
              <th>IP</th>
              <th>Details</th>
            </tr>
            </thead>
            <tbody id="securityBody"></tbody>
          </table>
        </div>
      </section>

    </section>

    <div class="footer">¬© 2025 Excellent Global Conceptional. All rights reserved.</div>
  </main>

  <!-- Firebase (v10 CDN) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, query, where, orderBy, onSnapshot, doc, deleteDoc, getDocs, limit
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ========= ADMIN WHITELIST =========
    const ADMIN_EMAILS = ["quareebalabi22@gmail.com"]; // add more when needed

    // ========= EMAILJS =========
    emailjs.init("h5LWzY8YUESb4sZbS");
    const EMAIL_SERVICE_ID = "service_cvvr3vn";
    const EMAIL_TEMPLATE_ID = "template_6xgms6a";
    const ADMIN_TO = "quareebalabi22@gmail.com";

    // ========= FIREBASE CONFIG =========
    const firebaseConfig = {
      apiKey: "AIzaSyDoTlLIlOyoYiTZLQmzVcDro-cw9TCU9qI",
      authDomain: "excellent-d056e.firebaseapp.com",
      projectId: "excellent-d056e",
      storageBucket: "excellent-d056e.firebasestorage.app",
      messagingSenderId: "629984941607",
      appId: "1:629984941607:web:3d7fc2478f555d45a0e002",
      measurementId: "G-G3RCTDSY27"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ========= UI ELEMENTS =========
    const appWrap = document.getElementById("app");
    const loginGate = document.getElementById("loginGate");
    const loginBtn = document.getElementById("loginBtn");
    const loginEmail = document.getElementById("loginEmail");
    const loginPass = document.getElementById("loginPass");
    const loginErr = document.getElementById("loginErr");
    const adminEmailEl = document.getElementById("adminEmail");
    const logoutBtn = document.getElementById("logoutBtn");
    const lastUpdated = document.getElementById("lastUpdated");

    // nav
    const navButtons = Array.from(document.querySelectorAll(".nav-btn"));
    navButtons.forEach(btn=>{
      btn.onclick = ()=> {
        navButtons.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const target = "section-" + btn.dataset.section;
        document.querySelectorAll("main section[id^='section-']").forEach(sec=>sec.classList.add("hidden"));
        document.getElementById(target).classList.remove("hidden");
      };
    });

    // login & gatekeeping
    onAuthStateChanged(auth, (user)=>{
      const allowed = !!user && ADMIN_EMAILS.includes((user.email||"").toLowerCase());
      if (allowed) {
        adminEmailEl.textContent = user.email;
        loginGate.classList.add("hidden");
        appWrap.classList.remove("hidden");
        bootAllStreams();
      } else {
        appWrap.classList.add("hidden");
        loginGate.classList.remove("hidden");
        adminEmailEl.textContent = "";
        // If someone non-admin tries to open this page while signed in, kick them out.
        if (user && !ADMIN_EMAILS.includes((user.email||"").toLowerCase())) {
          window.location.href = "welcome.html";
        }
      }
    });

    loginBtn.onclick = async ()=>{
      loginErr.textContent = "";
      try {
        await signInWithEmailAndPassword(auth, loginEmail.value.trim(), loginPass.value);
      } catch (e) {
        loginErr.textContent = "Login failed: " + (e?.message || e);
      }
    };
    logoutBtn.onclick = async ()=>{ try{await signOut(auth);}catch{} };

    // ========= DATA STREAMS & RENDER =========
    // Collections we read:
    // - "traffic" : { ip, isp, city, region, country, userAgent, page, ts: serverTimestamp() }
    // - "feedback": { project, name, email, topic, message, ip, isp, city, region, country, userAgent, createdAt }
    // - "security_logs": { event, ip, detail, ts }
    // - (optional) "project_clicks": { project, ts }

    const trafficBody = document.getElementById("trafficBody");
    const feedbackBody = document.getElementById("feedbackBody");
    const securityBody = document.getElementById("securityBody");

    const fIP = document.getElementById("fIP");
    const fISP = document.getElementById("fISP");
    const fCity = document.getElementById("fCity");
    document.getElementById("clearTraffic").onclick = ()=>{ fIP.value=fISP.value=fCity.value=""; renderTraffic(); };
    document.getElementById("qEmail").addEventListener("input", renderFeedback);
    document.getElementById("qProject").addEventListener("change", renderFeedback);
    document.getElementById("clearFeedback").onclick = ()=>{ document.getElementById("qEmail").value=""; document.getElementById("qProject").value=""; renderFeedback(); };

    document.getElementById("exportTraffic").onclick = ()=> exportTableCSV("traffic_export.csv", trafficBody, ["Time","IP","ISP","City","Region","Country","UserAgent","Page"]);
    document.getElementById("exportFeedback").onclick = ()=> exportTableCSV("feedback_export.csv", feedbackBody, ["Time","Project","Name","Email","Topic","Message","IP/ISP/City","Actions"]);
    document.getElementById("exportSecurity").onclick = ()=> exportTableCSV("security_export.csv", securityBody, ["Time","Event","IP","Details"]);

    const adminList = document.getElementById("adminList");
    adminList.innerHTML = ADMIN_EMAILS.map(e=>`<li>${e}</li>`).join("");

    // state
    let trafficDocs = [];
    let feedbackDocs = [];
    let securityDocs = [];
    let clicksDocs = [];

    // charts
    let visitorsChart, feedbackChart, projectClicksChart;

    function bootAllStreams(){
      // traffic (latest 500)
      onSnapshot(query(collection(db,"traffic"), orderBy("ts","desc"), limit(500)), (snap)=>{
        trafficDocs = snap.docs.map(d=>({id:d.id, ...d.data()}));
        renderTraffic();
        refreshOverview();
      });

      // feedback (latest 500)
      onSnapshot(query(collection(db,"feedback"), orderBy("createdAt","desc"), limit(500)), (snap)=>{
        feedbackDocs = snap.docs.map(d=>({id:d.id, ...d.data()}));
        renderFeedback();
        refreshOverview();
        drawFeedbackChart();
      });

      // security logs (latest 200)
      onSnapshot(query(collection(db,"security_logs"), orderBy("ts","desc"), limit(200)), (snap)=>{
        securityDocs = snap.docs.map(d=>({id:d.id, ...d.data()}));
        renderSecurity();
      });

      // optional clicks
      onSnapshot(query(collection(db,"project_clicks"), orderBy("ts","desc"), limit(1000)), (snap)=>{
        clicksDocs = snap.docs.map(d=>({id:d.id, ...d.data()}));
        drawProjectClicks();
      });
    }

    // helpers
    function toLagos(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
        return d ? d.toLocaleString("en-NG",{timeZone:"Africa/Lagos"}) : "";
      }catch{return "";}
    }
    function esc(s){
      return String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    }
    function exportTableCSV(filename, tbody, headers){
      const rows = [headers];
      tbody.querySelectorAll("tr").forEach(tr=>{
        const cols = Array.from(tr.children).map(td => `"${td.dataset.csv ?? td.textContent.replace(/"/g,'""')}"`);
        rows.push(cols);
      });
      const csv = rows.map(r=>r.join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href=url; a.download=filename; a.click();
      URL.revokeObjectURL(url);
    }

    // -------- Traffic render + filters --------
    function renderTraffic(){
      const f1 = fIP.value.trim().toLowerCase();
      const f2 = fISP.value.trim().toLowerCase();
      const f3 = fCity.value.trim().toLowerCase();
      const filtered = trafficDocs.filter(t=>{
        if (f1 && !(t.ip||"").toLowerCase().includes(f1)) return false;
        if (f2 && !(t.isp||"").toLowerCase().includes(f2)) return false;
        if (f3 && !(t.city||"").toLowerCase().includes(f3)) return false;
        return true;
      });
      trafficBody.innerHTML = "";
      for(const t of filtered){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(toLagos(t.ts))}</td>
          <td>${esc(t.ip || "")}</td>
          <td>${esc(t.isp || "")}<
