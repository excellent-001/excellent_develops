<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Dashboard â€” Excellent_Develops</title>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg1:#0f172a; --bg2:#0b1220; --card:#101826; --ink:#e5e7eb; --muted:#9ca3af;
    --accent:#3b82f6; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --line:#ffffff15;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
       background:radial-gradient(1200px 800px at 10% -10%, #1b2a4a 0%, transparent 60%),
                  radial-gradient(1000px 800px at 120% 10%, #132038 0%, transparent 55%),
                  linear-gradient(135deg,var(--bg1),var(--bg2));
       color:var(--ink); min-height:100vh; display:flex; flex-direction:column}
  header{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:12px;
         padding:14px 18px;border-bottom:1px solid var(--line);
         background:rgba(8,12,20,.6);backdrop-filter:blur(10px)}
  .brand{display:flex;align-items:center;gap:10px}
  .brand img{width:32px;height:32px;border-radius:8px}
  .brand h1{font-size:16px;margin:0}
  .right{margin-left:auto;display:flex;align-items:center;gap:10px}
  .chip{padding:4px 10px;border-radius:999px;background:#ffffff12;border:1px solid #ffffff22;color:var(--ink);font-size:12px}
  .toggle{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
  .toggle input{transform:scale(1.1)}
  .btn{border:1px solid #ffffff22;background:#0b1324;color:var(--ink);border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:#0000}
  .btn.ghost{background:#ffffff10}
  main{padding:18px;max-width:1200px;margin:0 auto;width:100%;display:grid;gap:16px}
  .grid{display:grid;gap:14px}
  .grid.cards{grid-template-columns:repeat(4,minmax(0,1fr))}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px #00000040}
  .pad{padding:16px}
  .kpi{display:flex;flex-direction:column;gap:6px}
  .kpi .label{color:var(--muted);font-size:12px}
  .kpi .value{font-size:24px;font-weight:700}
  .muted{color:var(--muted)}
  .section-title{display:flex;align-items:center;gap:10px;margin:0 0 10px 0}
  .filters{display:flex;gap:10px;flex-wrap:wrap}
  input,select{border-radius:10px;border:1px solid #ffffff22;background:#0b1324;color:var(--ink);padding:10px 12px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{text-align:left;padding:10px 12px;border-bottom:1px solid #ffffff14;font-size:14px;vertical-align:middle}
  th{position:sticky;top:0;background:#0f172a;z-index:1}
  .scroll{max-height:60vh;overflow:auto;border-radius:12px}
  .pill{padding:2px 8px;border-radius:999px;font-size:12px;display:inline-block}
  .pill.ok{background:#10b98122;color:var(--ok);border:1px solid #10b98155}
  .pill.warn{background:#f59e0b22;color:var(--warn);border:1px solid #f59e0b55}
  .pill.bad{background:#ef444422;color:var(--bad);border:1px solid #ef444455}
  .footer{padding:16px 20px;color:var(--muted);font-size:12px;text-align:center}
  .hidden{display:none}
  /* gate page */
  .gate{max-width:420px;margin:10vh auto}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
</style>
</head>
<body>

<header>
  <div class="brand">
    <img src="https://raw.githubusercontent.com/excellent-001/excellent_develops/refs/heads/main/logo.png" alt="Logo"/>
    <h1>Excellent_Develops Admin</h1>
    <span class="chip">Real-time</span>
  </div>
  <div class="right">
    <label class="toggle">
      <input type="checkbox" id="alertToggle">
      <span>Email alert on new feedback</span>
    </label>
    <span id="adminEmail" class="muted"></span>
    <button id="goSiteBtn" class="btn ghost">Go to site</button>
    <button id="signOutBtn" class="btn">Sign out</button>
  </div>
</header>

<main>
  <!-- Gate (shown if not allowed) -->
  <section id="gate" class="card pad gate hidden">
    <h2 style="margin:0 0 8px">Admin Access Required</h2>
    <p class="muted" style="margin:0 0 10px">
      This page requires a special link and an approved admin account.<br/>
      Make sure your URL includes <code>?admin=true</code> and you sign in with an approved email.
    </p>
    <div class="row" style="flex-direction:column;align-items:stretch">
      <input id="loginEmail" type="email" placeholder="Admin email"/>
      <input id="loginPass" type="password" placeholder="Password"/>
      <button id="loginBtn" class="btn primary">Sign in</button>
      <div id="loginErr" class="muted" style="margin-top:6px"></div>
    </div>
  </section>

  <!-- Dashboard -->
  <section id="dash" class="hidden">
    <!-- KPIs -->
    <div class="grid cards">
      <div class="card pad kpi"><span class="label">Total Users</span><span id="kpiUsers" class="value">0</span><span class="muted" id="kpiUsersSub">â€”</span></div>
      <div class="card pad kpi"><span class="label">New Users Today</span><span id="kpiUsersToday" class="value">0</span><span class="muted">00:00â€“23:59 (Africa/Lagos)</span></div>
      <div class="card pad kpi"><span class="label">Feedback (Total)</span><span id="kpiFb" class="value">0</span><span class="muted" id="kpiFbSub">â€”</span></div>
      <div class="card pad kpi"><span class="label">Feedback Today</span><span id="kpiFbToday" class="value">0</span><span class="muted">00:00â€“23:59 (Africa/Lagos)</span></div>
    </div>

    <!-- Traffic chart -->
    <div class="card pad">
      <h3 class="section-title">Traffic â€” last 14 days</h3>
      <canvas id="trafficChart" height="120"></canvas>
    </div>

    <!-- Feedback table -->
    <div class="card pad">
      <div class="section-title">
        <h3 style="margin:0">Feedback</h3>
        <span class="muted" id="lastUpdated">â€”</span>
        <div class="right filters">
          <input id="qSearch" placeholder="Search name/email/messageâ€¦"/>
          <select id="qProject">
            <option value="">All projects</option>
            <option value="excellent">Excellent Global Concept</option>
            <option value="pematech">Pematech Company</option>
            <option value="social">Social Intelligence Hub</option>
            <option value="lms">LMS / Educational</option>
          </select>
          <button id="exportCSV" class="btn ghost">Export CSV</button>
        </div>
      </div>
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>Project</th>
              <th>Name</th>
              <th>Email</th>
              <th>Message</th>
              <th>IP</th>
              <th>ISP</th>
              <th>City</th>
              <th>Submitted (Lagos)</th>
            </tr>
          </thead>
          <tbody id="fbBody"></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<div class="footer">Â© 2025 Excellent Global Conceptional. All rights reserved.</div>

<!-- EmailJS (for optional alerts) -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, collection, query, orderBy, onSnapshot, where, getDocs, serverTimestamp, addDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ===== ADMIN LIST =====
  const ADMIN_EMAILS = ["quareebalabi22@gmail.com"]; // add more later if needed

  // ===== Firebase Config =====
  const firebaseConfig = {
    apiKey: "AIzaSyDoTlLIlOyoYiTZLQmzVcDro-cw9TCU9qI",
    authDomain: "excellent-d056e.firebaseapp.com",
    projectId: "excellent-d056e",
    storageBucket: "excellent-d056e.firebasestorage.app",
    messagingSenderId: "629984941607",
    appId: "1:629984941607:web:3d7fc2478f555d45a0e002",
    measurementId: "G-G3RCTDSY27"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ===== EmailJS (optional alerts on new feedback) =====
  emailjs.init("h5LWzY8YUESb4sZbS"); // your public key
  const EMAIL_SERVICE = "service_cvvr3vn";
  const EMAIL_TEMPLATE = "template_6xgms6a";
  const ADMIN_ALERT_TO = "quareebalabi22@gmail.com";

  // ===== Elements =====
  const gate = document.getElementById("gate");
  const dash = document.getElementById("dash");
  const adminEmailEl = document.getElementById("adminEmail");
  const goSiteBtn = document.getElementById("goSiteBtn");
  const signOutBtn = document.getElementById("signOutBtn");
  const loginBtn = document.getElementById("loginBtn");
  const loginEmail = document.getElementById("loginEmail");
  const loginPass = document.getElementById("loginPass");
  const loginErr = document.getElementById("loginErr");

  const kpiUsers = document.getElementById("kpiUsers");
  const kpiUsersSub = document.getElementById("kpiUsersSub");
  const kpiUsersToday = document.getElementById("kpiUsersToday");
  const kpiFb = document.getElementById("kpiFb");
  const kpiFbSub = document.getElementById("kpiFbSub");
  const kpiFbToday = document.getElementById("kpiFbToday");

  const qSearch = document.getElementById("qSearch");
  const qProject = document.getElementById("qProject");
  const exportCSV = document.getElementById("exportCSV");
  const fbBody = document.getElementById("fbBody");
  const lastUpdated = document.getElementById("lastUpdated");
  const alertToggle = document.getElementById("alertToggle");

  goSiteBtn.onclick = () => { window.location.href = "welcome.html"; };

  // ===== Admin gate: requires ?admin=true AND admin email =====
  const params = new URLSearchParams(window.location.search);
  const ADMIN_PARAM = params.get("admin") === "true";

  let feedbackUnsub = null, usersUnsub = null, eventsUnsub = null;
  let feedbackData = [];
  let usersData = [];
  let trafficChart = null;
  let lastFeedbackSeen = 0; // for alerting
  alertToggle.checked = localStorage.getItem("exd_alerts") === "1";
  alertToggle.onchange = () => localStorage.setItem("exd_alerts", alertToggle.checked ? "1":"0");

  function showGate(){ gate.classList.remove("hidden"); dash.classList.add("hidden"); }
  function showDash(){ gate.classList.add("hidden"); dash.classList.remove("hidden"); }

  onAuthStateChanged(auth, async (user) => {
    const isAdminEmail = !!user && ADMIN_EMAILS.includes((user.email||"").toLowerCase());
    if (ADMIN_PARAM && isAdminEmail) {
      adminEmailEl.textContent = user.email;
      showDash();
      startStreams();
      // log admin visit (optional)
      try { await addDoc(collection(db,"events"), { type:"admin_visit", email:user.email, at: serverTimestamp() }); } catch {}
    } else {
      adminEmailEl.textContent = user?.email || "";
      showGate();
    }
  });

  loginBtn.onclick = async () => {
    loginErr.textContent = "";
    try {
      await signInWithEmailAndPassword(auth, loginEmail.value.trim(), loginPass.value);
      // onAuthStateChanged will handle the rest
    } catch (e) {
      loginErr.textContent = "Login failed: " + (e?.message || e);
    }
  };

  signOutBtn.onclick = async () => {
    try { await signOut(auth); } catch {}
    window.location.href = "index.html";
  };

  // ===== Real-time streams =====
  function startStreams(){
    // Users
    if (usersUnsub) usersUnsub();
    usersUnsub = onSnapshot(query(collection(db,"users"), orderBy("createdAt","desc")), (snap)=>{
      usersData = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      renderKPIs();
    });

    // Feedback
    if (feedbackUnsub) feedbackUnsub();
    feedbackUnsub = onSnapshot(query(collection(db,"feedback"), orderBy("createdAt","desc")), (snap)=>{
      const now = Date.now();
      const prevLatest = feedbackData[0]?.createdAt?.toMillis?.() ?? lastFeedbackSeen;
      feedbackData = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      renderFeedback();

      // detect new item for optional email alert
      const latest = feedbackData[0]?.createdAt?.toMillis?.() ?? 0;
      if (alertToggle.checked && latest && latest > (prevLatest||0)) {
        lastFeedbackSeen = latest;
        const f = feedbackData[0];
        sendEmailAlert(f).catch(()=>{});
      }
    });

    // Events for traffic graph (login/visit)
    if (eventsUnsub) eventsUnsub();
    eventsUnsub = onSnapshot(query(collection(db,"events"), orderBy("at","desc")), (snap)=>{
      const events = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      renderTraffic(events);
    });
  }

  // ===== Rendering =====
  function lagosTime(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
      return d ? d.toLocaleString("en-NG",{ timeZone:"Africa/Lagos" }) : "";
    }catch{ return ""; }
  }

  function todayBounds(){
    const now = new Date();
    const y = now.getFullYear(), m = now.getMonth(), d = now.getDate();
    const start = new Date(y,m,d,0,0,0);
    const end = new Date(y,m,d,23,59,59,999);
    return [start.getTime(), end.getTime()];
  }

  function renderKPIs(){
    // Total users
    kpiUsers.textContent = usersData.length.toString();
    // last user subtext
    if (usersData.length){
      kpiUsersSub.textContent = "Newest: " + (usersData[0].email||"") + " â€¢ " + lagosTime(usersData[0].createdAt);
    } else {
      kpiUsersSub.textContent = "â€”";
    }
    // New users today
    const [t0,t1] = todayBounds();
    const usersToday = usersData.filter(u=>{
      const ms = u.createdAt?.toMillis?.() ?? (u.createdAt ? new Date(u.createdAt).getTime() : 0);
      return ms>=t0 && ms<=t1;
    }).length;
    kpiUsersToday.textContent = usersToday.toString();

    // Feedback KPIs
    kpiFb.textContent = feedbackData.length.toString();
    if (feedbackData.length){
      kpiFbSub.textContent = "Latest: " + (feedbackData[0].project||"") + " â€¢ " + lagosTime(feedbackData[0].createdAt);
    } else {
      kpiFbSub.textContent = "â€”";
    }
    const fbToday = feedbackData.filter(f=>{
      const ms = f.createdAt?.toMillis?.() ?? (f.createdAt ? new Date(f.createdAt).getTime() : 0);
      return ms>=t0 && ms<=t1;
    }).length;
    kpiFbToday.textContent = fbToday.toString();
  }

  function passFbFilters(f){
    const q = (qSearch.value||"").toLowerCase();
    const proj = (qProject.value||"").toLowerCase();
    if (proj && String(f.project||"").toLowerCase() !== proj) return false;
    if (q){
      const hay = `${f.name||""} ${f.email||""} ${f.message||""}`.toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  }

  function renderFeedback(){
    fbBody.innerHTML = "";
    const rows = feedbackData.filter(passFbFilters);
    for (const f of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(labelProject(f.project))}</td>
        <td>${esc(f.name||"")}</td>
        <td>${esc(f.email||"")}</td>
        <td>${esc(f.message||"")}</td>
        <td>${esc(f.ip||"")}</td>
        <td>${esc(f.isp||"")}</td>
        <td>${esc(f.city||"")}</td>
        <td class="muted">${esc(lagosTime(f.createdAt))}</td>
      `;
      fbBody.appendChild(tr);
    }
    lastUpdated.textContent = "Last updated: " + new Date().toLocaleString("en-NG",{timeZone:"Africa/Lagos"});
    renderKPIs();
  }
  qSearch.addEventListener("input", renderFeedback);
  qProject.addEventListener("change", renderFeedback);

  function renderTraffic(events){
    // build last 14 days buckets
    const days = [];
    const counts = [];
    const now = new Date();
    for (let i=13;i>=0;i--){
      const d = new Date(now); d.setDate(now.getDate()-i);
      const key = d.toISOString().slice(0,10); // YYYY-MM-DD
      days.push(key);
      counts.push(0);
    }
    const ix = new Map(days.map((d,i)=>[d,i]));
    for (const ev of events){
      if (ev.type!=='login' && ev.type!=='visit' && ev.type!=='admin_visit') continue;
      const ms = ev.at?.toMillis?.() ?? (ev.at ? new Date(ev.at).getTime() : 0);
      if (!ms) continue;
      const ds = new Date(ms).toISOString().slice(0,10);
      const i = ix.get(ds);
      if (i!=null) counts[i] = (counts[i]||0) + 1;
    }

    const ctx = document.getElementById("trafficChart");
    if (trafficChart){ trafficChart.destroy(); }
    trafficChart = new Chart(ctx, {
      type: "line",
      data: { labels: days, datasets: [{ label:"Visits / Logins", data: counts, tension:.35 }] },
      options: {
        responsive:true,
        plugins:{ legend:{ display:false } },
        scales:{ x:{ grid:{ color:"#ffffff11" } }, y:{ beginAtZero:true, grid:{ color:"#ffffff11" } } }
      }
    });
  }

  function esc(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;")
      .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }
  function labelProject(k){
    switch((k||"").toLowerCase()){
      case "pematech": return "Pematech Company";
      case "social":   return "Social Intelligence Hub";
      case "lms":      return "LMS / Educational";
      case "excellent":
      default:         return "Excellent Global Concept";
    }
  }

  // ===== Export CSV =====
  exportCSV.onclick = () => {
    const rows = [["Project","Name","Email","Message","IP","ISP","City","Created (Lagos)"]];
    for (const f of feedbackData.filter(passFbFilters)){
      rows.push([
        labelProject(f.project||""), f.name||"", f.email||"", (f.message||"").replace(/\n/g," "),
        f.ip||"", f.isp||"", f.city||"", lagosTime(f.createdAt)
      ]);
    }
    const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "feedback_export.csv"; a.click();
    URL.revokeObjectURL(url);
  };

  // ===== Email alert on new feedback (optional) =====
  async function sendEmailAlert(f){
    try{
      await emailjs.send(EMAIL_SERVICE, EMAIL_TEMPLATE, {
        from_name: "Excellent_Develops Admin Alert",
        to_name: "Admin",
        to_email: ADMIN_ALERT_TO,
        message:
`ðŸ“¨ New Feedback

Project: ${labelProject(f.project)}
Name: ${f.name || "-"}
Email: ${f.email || "-"}
Message: ${f.message || "-"}

IP: ${f.ip || "-"}
ISP: ${f.isp || "-"}
City: ${f.city || "-"}
Time: ${lagosTime(f.createdAt)}`
      });
    }catch(e){ /* silent */ }
  }
</script>
</body>
</html>
