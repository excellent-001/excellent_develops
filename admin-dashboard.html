<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Dashboard — Excellent_Develops</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
  :root{
    --bg:#f6f7fb;
    --panel:#ffffff;
    --ink:#0f172a;
    --muted:#6b7280;
    --edge:#e5e7eb;
    --accent:#3b82f6;
    --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%}
  body{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    color: var(--ink);
    background:
      radial-gradient(40rem 20rem at -10% -10%, #dbeafe 0%, #f6f7fb 60%) no-repeat,
      radial-gradient(50rem 25rem at 110% -20%, #fde68a 0%, #f6f7fb 55%) no-repeat,
      var(--bg);
  }

  header{
    position:sticky; top:0; z-index:20;
    backdrop-filter:saturate(1.2) blur(8px);
    background: rgba(255,255,255,.7);
    border-bottom:1px solid var(--edge);
    display:flex; align-items:center; gap:14px; justify-content:space-between;
    padding:12px 16px;
  }
  header .brand { display:flex; align-items:center; gap:10px}
  header .brand h1{font-size:16px; margin:0}
  .chip{font-size:12px; padding:4px 8px; border-radius:999px; background:#eff6ff; color:#1d4ed8; border:1px solid #dbeafe}

  .wrap{max-width:1280px; margin:16px auto; padding:0 12px; display:grid; grid-template-columns:260px 1fr; gap:16px}
  @media (max-width: 960px){ .wrap{grid-template-columns:1fr} }

  nav{
    background: var(--panel); border:1px solid var(--edge); border-radius:14px; padding:10px; position:sticky; top:76px; align-self:start;
  }
  .navbtn{
    width:100%; text-align:left; border:1px solid var(--edge); background:#f9fafb;
    color:var(--ink); padding:10px 12px; border-radius:10px; margin:6px 0; cursor:pointer; display:flex; justify-content:space-between; align-items:center
  }
  .navbtn .count{font-size:12px; color:var(--muted)}
  .navbtn.active{ background:var(--accent); color:#fff; border-color:transparent }
  .btn{border:1px solid var(--edge); background:#f3f4f6; color:#111827; padding:9px 12px; border-radius:10px; cursor:pointer}
  .btn.primary{ background:var(--accent); color:#fff; border-color:transparent }
  .btn.danger{ background:#fee2e2; color:#b91c1c; border-color:#fecaca }
  .btn.ghost{ background:transparent }

  .card{background:var(--panel); border:1px solid var(--edge); border-radius:14px; padding:14px}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .grid{display:grid; gap:12px}
  .grid.kpi{grid-template-columns:repeat(3,1fr)}
  @media (max-width: 800px){ .grid.kpi{grid-template-columns:1fr} }

  .kpi{background:#f9fafb; border:1px dashed var(--edge); border-radius:12px; padding:14px}
  .kpi h3{margin:0 0 6px; color:var(--muted); font-size:13px}
  .kpi .val{font-size:22px; font-weight:700}

  .filters input{min-width:180px}
  input,select,textarea{
    border-radius:10px; border:1px solid var(--edge); background:#fff; color:#0f172a; padding:10px 12px;
  }
  textarea{width:100%}

  table{width:100%; border-collapse:separate; border-spacing:0; font-size:14px}
  th,td{padding:10px 12px; border-bottom:1px solid var(--edge); vertical-align:top}
  th{position:sticky; top:0; background:#fff; z-index:1}
  .scroll{max-height:60vh; overflow:auto; border:1px solid var(--edge); border-radius:12px}

  .muted{color:var(--muted)}
  .right{margin-left:auto}
  .hidden{display:none}
  .pill{padding:2px 8px; border-radius:999px; font-size:12px; display:inline-block}
  .pill.ok{background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0}
  .pill.warn{background:#fffbeb; color:#92400e; border:1px solid #fde68a}
  .pill.bad{background:#fef2f2; color:#991b1b; border:1px solid #fecaca}

  .footer{padding:18px; text-align:center; color:var(--muted)}

  /* Modal */
  .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(15,23,42,.4); z-index:50}
  .modal.open{display:grid}
  .modal .panel{background:#fff; border-radius:14px; border:1px solid var(--edge); padding:16px; width:min(680px,92vw)}
</style>
</head>
<body>

<header>
  <div class="brand">
    <span class="chip">Excellent_Develops</span>
    <h1>Admin Dashboard</h1>
  </div>
  <div class="row">
    <span id="adminEmail" class="muted"></span>
    <button id="signOutBtn" class="btn">Sign out</button>
  </div>
</header>

<div class="wrap">
  <!-- LEFT NAV -->
  <nav>
    <button class="navbtn active" data-tab="overview">Overview</button>
    <button class="navbtn" data-tab="feedback">Feedback <span class="count" id="navCountFeedback"></span></button>
    <button class="navbtn" data-tab="visitors">Visitors <span class="count" id="navCountVisitors"></span></button>
    <button class="navbtn" data-tab="users">Users <span class="count" id="navCountUsers"></span></button>
    <button class="navbtn" data-tab="replies">Replies</button>
    <button class="navbtn" data-tab="settings">Settings</button>
  </nav>

  <!-- RIGHT CONTENT -->
  <div class="grid" style="gap:16px">
    <!-- OVERVIEW -->
    <section id="tab-overview" class="card">
      <div class="row" style="align-items:flex-start">
        <div>
          <h2 style="margin:0 0 8px">Overview</h2>
          <p class="muted" style="margin:0">Quick stats + trends</p>
        </div>
        <span class="muted right" id="lastUpdated">—</span>
      </div>

      <div class="grid kpi" style="margin-top:12px">
        <div class="kpi"><h3>Total Feedback</h3><div class="val" id="kpiFeedback">0</div></div>
        <div class="kpi"><h3>Total Visitors</h3><div class="val" id="kpiVisitors">0</div></div>
        <div class="kpi"><h3>Registered Users</h3><div class="val" id="kpiUsers">0</div></div>
      </div>

      <div class="grid" style="grid-template-columns:1fr 1fr; gap:16px; margin-top:14px">
        <div class="card" style="padding:10px">
          <div class="row"><strong>Feedback per Project</strong><span class="muted right" id="c1info"></span></div>
          <canvas id="chartProjects" height="200"></canvas>
        </div>
        <div class="card" style="padding:10px">
          <div class="row"><strong>Visitors by City</strong><span class="muted right" id="c2info"></span></div>
          <canvas id="chartCities" height="200"></canvas>
        </div>
      </div>

      <div class="card" style="padding:10px; margin-top:14px">
        <div class="row"><strong>Feedback Timeline</strong><span class="muted right" id="c3info"></span></div>
        <canvas id="chartTimeline" height="180"></canvas>
      </div>
    </section>

    <!-- FEEDBACK -->
    <section id="tab-feedback" class="card hidden">
      <div class="row">
        <h2 style="margin:0">Feedback</h2>
        <div class="right row">
          <button id="bulkReply" class="btn">Reply selected</button>
          <button id="exportFeedback" class="btn">Export CSV</button>
        </div>
      </div>
      <div class="row filters" style="margin:10px 0">
        <input id="fProject" placeholder="Filter by project…"/>
        <input id="fText" placeholder="Search name/email/message…"/>
        <input id="fIP" placeholder="Filter by IP…"/>
        <button id="clearF" class="btn">Clear</button>
      </div>
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th><input type="checkbox" id="fbSelectAll"/></th>
              <th>Project</th><th>Name</th><th>Email</th><th>Message</th>
              <th>IP</th><th>ISP</th><th>City</th><th>Created (Lagos)</th><th>Action</th>
            </tr>
          </thead>
          <tbody id="tbodyFeedback"></tbody>
        </table>
      </div>
    </section>

    <!-- VISITORS -->
    <section id="tab-visitors" class="card hidden">
      <div class="row">
        <h2 style="margin:0">Visitors</h2>
        <button id="exportVisitors" class="btn right">Export CSV</button>
      </div>
      <div class="row filters" style="margin:10px 0">
        <input id="vPage" placeholder="Filter by page…"/>
        <input id="vIP" placeholder="Filter by IP…"/>
        <input id="vISP" placeholder="Filter by ISP…"/>
        <input id="vCity" placeholder="Filter by City…"/>
        <button id="clearV" class="btn">Clear</button>
      </div>
      <div class="scroll">
        <table>
          <thead>
            <tr><th>Page</th><th>User</th><th>IP</th><th>ISP</th><th>City</th><th>Created (Lagos)</th></tr>
          </thead>
          <tbody id="tbodyVisitors"></tbody>
        </table>
      </div>
    </section>

    <!-- USERS -->
    <section id="tab-users" class="card hidden">
      <div class="row">
        <h2 style="margin:0">Users</h2>
        <button id="exportUsers" class="btn right">Export CSV</button>
      </div>
      <div class="row filters" style="margin:10px 0">
        <input id="uEmail" placeholder="Filter by email…"/>
        <input id="uIP" placeholder="Filter by IP…"/>
        <input id="uISP" placeholder="Filter by ISP…"/>
        <input id="uCity" placeholder="Filter by City…"/>
        <button id="clearU" class="btn">Clear</button>
      </div>
      <div class="scroll">
        <table>
          <thead>
            <tr><th>Name</th><th>Email</th><th>IP</th><th>ISP</th><th>City</th><th>Created (Lagos)</th></tr>
          </thead>
          <tbody id="tbodyUsers"></tbody>
        </table>
      </div>
    </section>

    <!-- REPLIES -->
    <section id="tab-replies" class="card hidden">
      <div class="row">
        <h2 style="margin:0">Replies</h2>
        <span class="muted">All email replies sent from this dashboard</span>
        <button id="exportReplies" class="btn right">Export CSV</button>
      </div>
      <div class="scroll" style="margin-top:10px">
        <table>
          <thead>
            <tr><th>To</th><th>Mode</th><th>Subject</th><th>Message</th><th>Linked Feedback</th><th>Status</th><th>Sent (Lagos)</th></tr>
          </thead>
        <tbody id="tbodyReplies"></tbody>
        </table>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" class="card hidden">
      <h2 style="margin-top:0">Settings</h2>
      <p class="muted">Saved in Firestore at <code>siteSettings/global</code>.</p>
      <div class="row" style="align-items:flex-start">
        <div style="flex:1;min-width:260px">
          <label class="muted">Global Banner Text</label>
          <textarea id="setBanner" rows="3" placeholder="Optional banner text shown on project pages"></textarea>
        </div>
        <div style="flex:1;min-width:260px">
          <label class="muted" style="display:block;margin-bottom:6px">Coming Soon (per project)</label>
          <label><input type="checkbox" id="csExcellent"> Excellent Global Concept</label><br/>
          <label><input type="checkbox" id="csPematech"> Pematech Company</label><br/>
          <label><input type="checkbox" id="csSocial"> Social Intelligence Hub</label><br/>
          <label><input type="checkbox" id="csLms"> LMS / Educational</label>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="saveSettings" class="btn primary">Save Settings</button>
        <span id="saveMsg" class="muted"></span>
      </div>
    </section>
  </div>
</div>

<!-- Reply Modal -->
<div id="replyModal" class="modal">
  <div class="panel">
    <div class="row">
      <h3 style="margin:0">Send Reply</h3>
      <button id="replyClose" class="btn right">Close</button>
    </div>
    <p class="muted" id="replyMeta" style="margin:6px 0 12px"></p>
    <div class="row">
      <label><input type="radio" name="replyMode" value="user" /> Email user</label>
      <label><input type="radio" name="replyMode" value="admin" checked /> Email me (admin) only</label>
    </div>
    <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px">
      <div>
        <label class="muted">To</label>
        <input id="replyTo" placeholder="recipient email" />
      </div>
      <div>
        <label class="muted">Subject</label>
        <input id="replySubject" placeholder="Subject"/>
      </div>
    </div>
    <div style="margin-top:8px">
      <label class="muted">Message</label>
      <textarea id="replyBody" rows="6" placeholder="Type your reply…"></textarea>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="replySend" class="btn primary">Send</button>
      <span id="replyStatus" class="muted"></span>
    </div>
  </div>
</div>

<div class="footer">© 2025 Excellent Global Conceptional. All rights reserved.</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, deleteDoc,
    collection, onSnapshot, query, orderBy, addDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  /************** SECURITY GATES **************/
  const ADMIN_EMAILS = ["quareebalabi22@gmail.com"];
  const SECRET_CODE  = "554455";
  const ADMIN_KEY    = "Blessing@001";

  // Secret URL param check
  const params = new URLSearchParams(location.search);
  if (params.get("code") !== SECRET_CODE) {
    document.body.innerHTML = "<div style='padding:40px;font-family:system-ui'><h2>Access denied</h2><p>You need the correct code to open this page.</p></div>";
    throw new Error("Missing/invalid code");
  }

  // Admin key prompt (session only)
  const KEY_FLAG = "exd_admin_key_ok";
  const okKey = sessionStorage.getItem(KEY_FLAG);
  if (okKey !== "1") {
    const entered = prompt("Admin key required:");
    if (entered !== ADMIN_KEY) {
      document.body.innerHTML = "<div style='padding:40px;font-family:system-ui'><h2>Access denied</h2><p>Invalid admin key.</p></div>";
      throw new Error("Invalid admin key");
    }
    sessionStorage.setItem(KEY_FLAG, "1");
  }

  /************** FIREBASE **************/
  // ===== Firebase Config =====
  const firebaseConfig = {
    apiKey: "AIzaSyDoTlLIlOyoYiTZLQmzVcDro-cw9TCU9qI",
    authDomain: "excellent-d056e.firebaseapp.com",
    projectId: "excellent-d056e",
    storageBucket: "excellent-d056e.firebasestorage.app",
    messagingSenderId: "629984941607",
    appId: "1:629984941607:web:3d7fc2478f555d45a0e002",
    measurementId: "G-G3RCTDSY27"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  /************** EmailJS **************/
  // Your provided credentials:
  // Service ID: service_cvvr3vn
  // Template ID: template_6xgms6a
  // Public Key: h5LWzY8YUESb4sZ
  emailjs.init("h5LWzY8YUESb4sZ");
  const EMAIL_SERVICE = "service_cvvr3vn";
  const EMAIL_TEMPLATE = "template_6xgms6a";
  const ADMIN_ALERT_TO = "quareebalabi22@gmail.com";

  /************** UI ELEMENTS **************/
  const adminEmailEl = document.getElementById("adminEmail");
  const signOutBtn   = document.getElementById("signOutBtn");
  const lastUpdated  = document.getElementById("lastUpdated");

  // Nav + Tabs
  const tabButtons = [...document.querySelectorAll(".navbtn")];
  const tabs = {
    overview: document.getElementById("tab-overview"),
    feedback: document.getElementById("tab-feedback"),
    visitors: document.getElementById("tab-visitors"),
    users: document.getElementById("tab-users"),
    replies: document.getElementById("tab-replies"),
    settings: document.getElementById("tab-settings")
  };
  tabButtons.forEach(b=>{
    b.onclick = ()=>{
      tabButtons.forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      const t = b.dataset.tab;
      Object.entries(tabs).forEach(([k,el])=> el.classList.toggle("hidden", k!==t));
    };
  });

  // KPIs
  const kpiFeedback = document.getElementById("kpiFeedback");
  const kpiVisitors = document.getElementById("kpiVisitors");
  const kpiUsers    = document.getElementById("kpiUsers");
  const navCountFeedback = document.getElementById("navCountFeedback");
  const navCountVisitors = document.getElementById("navCountVisitors");
  const navCountUsers    = document.getElementById("navCountUsers");

  // Feedback filters/table
  const fProject = document.getElementById("fProject");
  const fText    = document.getElementById("fText");
  const fIP      = document.getElementById("fIP");
  const clearF   = document.getElementById("clearF");
  const tbodyFeedback  = document.getElementById("tbodyFeedback");
  const exportFeedback = document.getElementById("exportFeedback");
  const fbSelectAll    = document.getElementById("fbSelectAll");
  const bulkReply      = document.getElementById("bulkReply");

  // Visitors filters/table
  const vPage = document.getElementById("vPage");
  const vIP   = document.getElementById("vIP");
  const vISP  = document.getElementById("vISP");
  const vCity = document.getElementById("vCity");
  const clearV= document.getElementById("clearV");
  const tbodyVisitors = document.getElementById("tbodyVisitors");
  const exportVisitors= document.getElementById("exportVisitors");

  // Users filters/table
  const uEmail = document.getElementById("uEmail");
  const uIP    = document.getElementById("uIP");
  const uISP   = document.getElementById("uISP");
  const uCity  = document.getElementById("uCity");
  const clearU = document.getElementById("clearU");
  const tbodyUsers = document.getElementById("tbodyUsers");
  const exportUsers= document.getElementById("exportUsers");

  // Replies table
  const tbodyReplies = document.getElementById("tbodyReplies");
  const exportReplies= document.getElementById("exportReplies");

  // Settings
  const setBanner   = document.getElementById("setBanner");
  const csExcellent = document.getElementById("csExcellent");
  const csPematech  = document.getElementById("csPematech");
  const csSocial    = document.getElementById("csSocial");
  const csLms       = document.getElementById("csLms");
  const saveSettings= document.getElementById("saveSettings");
  const saveMsg     = document.getElementById("saveMsg");

  // Reply Modal
  const replyModal   = document.getElementById("replyModal");
  const replyClose   = document.getElementById("replyClose");
  const replyMeta    = document.getElementById("replyMeta");
  const replyTo      = document.getElementById("replyTo");
  const replySubject = document.getElementById("replySubject");
  const replyBody    = document.getElementById("replyBody");
  const replySend    = document.getElementById("replySend");
  const replyStatus  = document.getElementById("replyStatus");
  const replyModeRadios = ()=> [...document.querySelectorAll('input[name="replyMode"]')];

  /************** HELPERS **************/
  function lagosTime(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
      return d ? d.toLocaleString("en-NG",{ timeZone:"Africa/Lagos" }) : "";
    } catch { return ""; }
  }
  function esc(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;")
      .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }
  function csvDownload(filename, rows){
    const csv = rows.map(r => r.map(v => `"${String(v??"").replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  function openReplyModal(preset){
    replyMeta.textContent = preset ? `Replying to: ${preset.name||"(no name)"} — ${preset.email||"(no email)"} — ${preset.project||"(no project)"}` : "New reply";
    const adminEmail = adminEmailEl.textContent || ADMIN_ALERT_TO;
    const mode = replyModeRadios().find(r => r.checked)?.value || "ad
