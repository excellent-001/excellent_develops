<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin — Excellent_Develops</title>
<style>
  :root{
    --ink:#e5e7eb; --muted:#9ca3af; --bg1:#0b1220; --bg2:#0f172a;
    --card:#101726; --edge:#1f2937; --accent:#3b82f6; --ok:#10b981; --bad:#ef4444; --warn:#f59e0b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;color:var(--ink);
       background:linear-gradient(135deg,var(--bg1),var(--bg2));display:flex;flex-direction:column}
  body.locked{visibility:hidden} /* hide until all gates passed */
  header{display:flex;align-items:center;gap:12px;justify-content:space-between;padding:16px 20px;border-bottom:1px solid #00000040;background:rgba(0,0,0,.25);backdrop-filter:blur(6px)}
  header h1{margin:0;font-size:18px}
  .chip{padding:4px 10px;border-radius:999px;background:#ffffff12;border:1px solid #ffffff22;font-size:12px}
  .btn{border:1px solid #ffffff22;background:#0b1324;color:var(--ink);padding:9px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:transparent}
  .btn.danger{background:#ef444433;border-color:#ef444455}
  .btn.ghost{background:#ffffff10}
  main{display:grid;grid-template-columns:240px 1fr; gap:16px; padding:18px; max-width:1400px; margin:0 auto; width:100%}
  nav{background:var(--card);border:1px solid #ffffff12;border-radius:14px;padding:10px}
  nav button{width:100%; text-align:left; margin:6px 0}
  nav .active{background:var(--accent);border-color:transparent}
  section.card{background:var(--card);border:1px solid #ffffff12;border-radius:14px;padding:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .kpi{background:#0b1324;border:1px solid #ffffff1a;border-radius:16px;padding:16px}
  .kpi h3{margin:0 0 6px 0;font-size:13px;color:var(--muted);font-weight:600}
  .kpi .val{font-size:22px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px 12px;border-bottom:1px solid #ffffff14;text-align:left;font-size:14px;vertical-align:middle}
  th{position:sticky;top:0;background:#111827;z-index:1}
  .scroll{max-height:65vh;overflow:auto;border-radius:12px;border:1px solid #ffffff10}
  input,select,textarea{border-radius:10px;border:1px solid #ffffff22;background:#0b1324;color:var(--ink);padding:10px 12px;width:100%}
  .muted{color:var(--muted)}
  .right{margin-left:auto}
  .hidden{display:none}
  .pill{padding:2px 8px;border-radius:999px;font-size:12px;display:inline-block}
  .pill.ok{background:#10b98122;color:var(--ok);border:1px solid #10b98155}
  .pill.bad{background:#ef444422;color:var(--bad);border:1px solid #ef444455}
  .pill.warn{background:#f59e0b22;color:var(--warn);border:1px solid #f59e0b55}
  .footer{padding:18px 20px;color:var(--muted);font-size:12px;text-align:center}
</style>

<!-- EmailJS (optional; disabled by default) -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script type="module">
/** =================== HARDENED ENTRY GATES ===================
 * Gate A: secret key in URL (?key=Blessing@001)
 * Gate B: PIN prompt (554455) – once per session
 * Gate C: Firebase auth email allow-list
 * Notes: These client-side gates are “speed bumps.” The real lock is Gate C.
 */
document.documentElement.classList.remove('no-js');
document.body.classList.add('locked'); // keep hidden until we pass all gates

const SECRET_KEY = "Blessing@001";
const SECRET_PIN = "554455";
const ADMIN_EMAILS = ["quareebalabi22@gmail.com"]; // add more if needed

const url = new URL(location.href);
const key = url.searchParams.get('key');
if (key !== SECRET_KEY) {
  // wrong/missing key → bounce out immediately
  location.replace("index.html");
} else {
  // ask PIN once per session
  const okPin = sessionStorage.getItem("admin_pin_ok") === "1";
  if (!okPin) {
    const entered = prompt("Enter admin PIN");
    if (entered !== SECRET_PIN) {
      alert("Invalid PIN.");
      location.replace("index.html");
    } else {
      sessionStorage.setItem("admin_pin_ok","1");
    }
  }
}
</script>
</head>

<body class="locked">
<header>
  <h1>Admin Control Center <span class="chip">Excellent_Develops</span></h1>
  <div class="row">
    <span id="adminEmail" class="muted"></span>
    <button id="signOutBtn" class="btn ghost">Sign out</button>
  </div>
</header>

<main>
  <!-- LEFT NAV -->
  <nav>
    <button class="btn active" data-tab="overview">Overview</button>
    <button class="btn" data-tab="feedback">Feedback</button>
    <button class="btn" data-tab="visitors">Visitors</button>
    <button class="btn" data-tab="users">Users</button>
    <button class="btn" data-tab="settings">Settings</button>
  </nav>

  <!-- RIGHT CONTENT -->
  <div>
    <!-- OVERVIEW -->
    <section id="tab-overview" class="card">
      <h2 style="margin-top:0">Overview</h2>
      <div class="grid">
        <div class="kpi"><h3>Total Feedback</h3><div class="val" id="kpiFeedback">0</div></div>
        <div class="kpi"><h3>Total Visitors</h3><div class="val" id="kpiVisitors">0</div></div>
        <div class="kpi"><h3>Registered Users</h3><div class="val" id="kpiUsers">0</div></div>
      </div>
      <p class="muted" id="lastUpdated" style="margin-top:12px">—</p>
    </section>

    <!-- FEEDBACK -->
    <section id="tab-feedback" class="card hidden">
      <div class="row">
        <h2 style="margin:0">Feedback</h2>
        <button id="exportFeedback" class="btn right">Export CSV</button>
      </div>
      <div class="row" style="margin:10px 0">
        <input id="fProject" placeholder="Filter by project…"/>
        <input id="fEmail" placeholder="Filter by email…"/>
        <input id="fIP" placeholder="Filter by IP…"/>
        <button id="clearF" class="btn ghost">Clear</button>
      </div>
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>Project</th><th>Name</th><th>Email</th><th>Message</th>
              <th>IP</th><th>ISP</th><th>City</th><th>Created (Lagos)</th><th>Action</th>
            </tr>
          </thead>
          <tbody id="tbodyFeedback"></tbody>
        </table>
      </div>
    </section>

    <!-- VISITORS -->
    <section id="tab-visitors" class="card hidden">
      <div class="row">
        <h2 style="margin:0">Visitors</h2>
        <button id="exportVisitors" class="btn right">Export CSV</button>
      </div>
      <div class="row" style="margin:10px 0">
        <input id="vPage" placeholder="Filter by page…"/>
        <input id="vIP" placeholder="Filter by IP…"/>
        <input id="vISP" placeholder="Filter by ISP…"/>
        <input id="vCity" placeholder="Filter by City…"/>
        <button id="clearV" class="btn ghost">Clear</button>
      </div>
      <div class="scroll">
        <table>
          <thead>
            <tr><th>Page</th><th>User</th><th>IP</th><th>ISP</th><th>City</th><th>Created (Lagos)</th></tr>
          </thead>
          <tbody id="tbodyVisitors"></tbody>
        </table>
      </div>
    </section>

    <!-- USERS -->
    <section id="tab-users" class="card hidden">
      <div class="row">
        <h2 style="margin:0">Users</h2>
        <button id="exportUsers" class="btn right">Export CSV</button>
      </div>
      <div class="row" style="margin:10px 0">
        <input id="uEmail" placeholder="Filter by email…"/>
        <input id="uIP" placeholder="Filter by IP…"/>
        <input id="uISP" placeholder="Filter by ISP…"/>
        <input id="uCity" placeholder="Filter by City…"/>
        <button id="clearU" class="btn ghost">Clear</button>
      </div>
      <div class="scroll">
        <table>
          <thead>
            <tr><th>Name</th><th>Email</th><th>IP</th><th>ISP</th><th>City</th><th>Created (Lagos)</th></tr>
          </thead>
          <tbody id="tbodyUsers"></tbody>
        </table>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" class="card hidden">
      <h2 style="margin-top:0">Settings</h2>
      <p class="muted">Stored at <code>siteSettings/global</code>. These drive banners & per-project “Coming Soon”.</p>
      <div class="row" style="align-items:flex-start">
        <div style="flex:1;min-width:260px">
          <label class="muted">Global Banner Text</label>
          <textarea id="setBanner" rows="3" placeholder="Optional banner text on project pages"></textarea>
        </div>
        <div style="flex:1;min-width:260px">
          <label class="muted">Coming Soon (per project)</label>
          <div class="row" style="flex-direction:column;gap:8px;align-items:flex-start">
            <label><input type="checkbox" id="csExcellent"> Excellent Global Concept</label>
            <label><input type="checkbox" id="csPematech"> Pematech Company</label>
            <label><input type="checkbox" id="csSocial"> Social Intelligence Hub</label>
            <label><input type="checkbox" id="csLms"> LMS / Educational</label>
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="saveSettings" class="btn primary">Save Settings</button>
        <span id="saveMsg" class="muted"></span>
      </div>
    </section>
  </div>
</main>

<div class="footer">© 2025 Excellent Global Conceptional. All rights reserved.</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, deleteDoc,
    collection, onSnapshot, query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ====== CONFIG ======
  const ADMIN_EMAILS = ["quareebalabi22@gmail.com"]; // extend later if needed
  const firebaseConfig = {
    apiKey: "AIzaSyDoTlLIlOyoYiTZLQmzVcDro-cw9TCU9qI",
    authDomain: "excellent-d056e.firebaseapp.com",
    projectId: "excellent-d056e",
    storageBucket: "excellent-d056e.firebasestorage.app",
    messagingSenderId: "629984941607",
    appId: "1:629984941607:web:3d7fc2478f555d45a0e002",
    measurementId: "G-G3RCTDSY27"
  };

  // OPTIONAL: EmailJS admin notifications (disabled by default)
  // emailjs.init("h5LWzY8YUESb4sZbS");
  const MAIL_SERVICE = "service_cvvr3vn";
  const MAIL_TEMPLATE = "template_6xgms6a";
  const ADMIN_NOTIFY = "quareebalabi22@gmail.com";

  // ====== INIT ======
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ====== ELEMENTS ======
  const adminEmailEl = document.getElementById("adminEmail");
  const signOutBtn = document.getElementById("signOutBtn");
  const lastUpdated = document.getElementById("lastUpdated");

  // Tabs
  const tabButtons = [...document.querySelectorAll("nav .btn")];
  const tabs = {
    overview: document.getElementById("tab-overview"),
    feedback: document.getElementById("tab-feedback"),
    visitors: document.getElementById("tab-visitors"),
    users: document.getElementById("tab-users"),
    settings: document.getElementById("tab-settings")
  };
  tabButtons.forEach(b=>{
    b.onclick = ()=> {
      tabButtons.forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      const t = b.dataset.tab;
      Object.entries(tabs).forEach(([k,el])=> el.classList.toggle("hidden", k!==t));
    };
  });

  // KPIs
  const kpiFeedback = document.getElementById("kpiFeedback");
  const kpiVisitors = document.getElementById("kpiVisitors");
  const kpiUsers = document.getElementById("kpiUsers");

  // Feedback filters/table
  const fProject = document.getElementById("fProject");
  const fEmail = document.getElementById("fEmail");
  const fIP = document.getElementById("fIP");
  const clearF = document.getElementById("clearF");
  const tbodyFeedback = document.getElementById("tbodyFeedback");
  const exportFeedback = document.getElementById("exportFeedback");

  // Visitors filters/table
  const vPage = document.getElementById("vPage");
  const vIP = document.getElementById("vIP");
  const vISP = document.getElementById("vISP");
  const vCity = document.getElementById("vCity");
  const clearV = document.getElementById("clearV");
  const tbodyVisitors = document.getElementById("tbodyVisitors");
  const exportVisitors = document.getElementById("exportVisitors");

  // Users filters/table
  const uEmail = document.getElementById("uEmail");
  const uIP = document.getElementById("uIP");
  const uISP = document.getElementById("uISP");
  const uCity = document.getElementById("uCity");
  const clearU = document.getElementById("clearU");
  const tbodyUsers = document.getElementById("tbodyUsers");
  const exportUsers = document.getElementById("exportUsers");

  // Settings
  const setBanner = document.getElementById("setBanner");
  const csExcellent = document.getElementById("csExcellent");
  const csPematech = document.getElementById("csPematech");
  const csSocial = document.getElementById("csSocial");
  const csLms = document.getElementById("csLms");
  const saveSettings = document.getElementById("saveSettings");
  const saveMsg = document.getElementById("saveMsg");

  // ====== ADMIN GUARD (Gate C) ======
  onAuthStateChanged(auth, async (user)=>{
    const email = (user?.email||"").toLowerCase();
    const allowed = !!user && ADMIN_EMAILS.includes(email);
    if (!allowed) {
      // bounce to index with admin flag (so your index shows the admin login UI)
      window.location.href = "index.html?admin=1";
      return;
    }
    adminEmailEl.textContent = email;
    document.body.classList.remove("locked"); // show UI after all gates passed
    boot();
  });

  signOutBtn.onclick = async ()=>{ try{await signOut(auth);}catch{} window.location.href="index.html"; };

  // ====== DATA STREAMS ======
  let feedbackRows = [];
  let visitorRows = [];
  let userRows = [];

  function lagosTime(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
      return d ? d.toLocaleString("en-NG",{ timeZone:"Africa/Lagos" }) : "";
    } catch { return ""; }
  }
  function esc(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;")
      .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function passF(r){
    const p=(fProject.value||"").toLowerCase();
    const e=(fEmail.value||"").toLowerCase();
    const ip=(fIP.value||"").toLowerCase();
    if (p && !(r.project||"").toLowerCase().includes(p)) return false;
    if (e && !(r.email||"").toLowerCase().includes(e)) return false;
    if (ip && !(r.ip||"").toLowerCase().includes(ip)) return false;
    return true;
  }
  function passV(r){
    const p=(vPage.value||"").toLowerCase();
    const ip=(vIP.value||"").toLowerCase();
    const isp=(vISP.value||"").toLowerCase();
    const c=(vCity.value||"").toLowerCase();
    if (p && !(r.page||"").toLowerCase().includes(p)) return false;
    if (ip && !(r.ip||"").toLowerCase().includes(ip)) return false;
    if (isp && !(r.isp||"").toLowerCase().includes(isp)) return false;
    if (c && !(r.city||"").toLowerCase().includes(c)) return false;
    return true;
  }
  function passU(r){
    const e=(uEmail.value||"").toLowerCase();
    const ip=(uIP.value||"").toLowerCase();
    const isp=(uISP.value||"").toLowerCase();
    const c=(uCity.value||"").toLowerCase();
    if (e && !(r.email||"").toLowerCase().includes(e)) return false;
    if (ip && !(r.ip||"").toLowerCase().includes(ip)) return false;
    if (isp && !(r.isp||"").toLowerCase().includes(isp)) return false;
    if (c && !(r.city||"").toLowerCase().includes(c)) return false;
    return true;
  }

  function renderFeedback(){
    const rows = feedbackRows.filter(passF);
    tbodyFeedback.innerHTML = "";
    for (const r of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(r.project||"")}</td>
        <td>${esc(r.name||"")}</td>
        <td>${esc(r.email||"")}</td>
        <td>${esc(r.message||"")}</td>
        <td>${esc(r.ip||"")}</td>
        <td>${esc(r.isp||"")}</td>
        <td>${esc(r.city||"")}</td>
        <td class="muted">${esc(lagosTime(r.createdAt))}</td>
        <td><button class="btn danger" data-id="${r.id}">Delete</button></td>
      `;
      tbodyFeedback.appendChild(tr);
    }
    kpiFeedback.textContent = feedbackRows.length;

    // bind delete
    [...tbodyFeedback.querySelectorAll("button[data-id]")].forEach(btn=>{
      btn.onclick = async ()=>{
        if (!confirm("Delete this feedback?")) return;
        await deleteDoc(doc(db,"feedback", btn.dataset.id));
        // Optional: notify admin
        // emailjs.send(MAIL_SERVICE, MAIL_TEMPLATE, {
        //   from_name: "Admin Action",
        //   to_name: "Admin",
        //   to_email: ADMIN_NOTIFY,
        //   message: `A feedback document was deleted by ${adminEmailEl.textContent}`
        // });
      };
    });
  }

  function renderVisitors(){
    const rows = visitorRows.filter(passV);
    tbodyVisitors.innerHTML = "";
    for (const r of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(r.page||"")}</td>
        <td>${esc(r.userEmail||"")}</td>
        <td>${esc(r.ip||"")}</td>
        <td>${esc(r.isp||"")}</td>
        <td>${esc(r.city||"")}</td>
        <td class="muted">${esc(lagosTime(r.createdAt))}</td>
      `;
      tbodyVisitors.appendChild(tr);
    }
    kpiVisitors.textContent = visitorRows.length;
  }

  function renderUsers(){
    const rows = userRows.filter(passU);
    tbodyUsers.innerHTML = "";
    for (const r of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(r.name||"")}</td>
        <td>${esc(r.email||"")}</td>
        <td>${esc(r.ip||"")}</td>
        <td>${esc(r.isp||"")}</td>
        <td>${esc(r.city||"")}</td>
        <td class="muted">${esc(lagosTime(r.createdAt))}</td>
      `;
      tbodyUsers.appendChild(tr);
    }
    kpiUsers.textContent = userRows.length;
  }

  function csvDownload(filename, rows){
    const csv = rows.map(r => r.map(v => `"${String(v??"").replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  exportFeedback.onclick = ()=>{
    const rows = [["Project","Name","Email","Message","IP","ISP","City","Created(Lagos)"]];
    for (const r of feedbackRows.filter(passF)){
      rows.push([r.project||"",r.name||"",r.email||"",r.message||"",r.ip||"",r.isp||"",r.city||"",lagosTime(r.createdAt)]);
    }
    csvDownload("feedback.csv", rows);
  };
  exportVisitors.onclick = ()=>{
    const rows = [["Page","User","IP","ISP","City","Created(Lagos)"]];
    for (const r of visitorRows.filter(passV)){
      rows.push([r.page||"",r.userEmail||"",r.ip||"",r.isp||"",r.city||"",lagosTime(r.createdAt)]);
    }
    csvDownload("visitors.csv", rows);
  };
  exportUsers.onclick = ()=>{
    const rows = [["Name","Email","IP","ISP","City","Created(Lagos)"]];
    for (const r of userRows.filter(passU)){
      rows.push([r.name||"",r.email||"",r.ip||"",r.isp||"",r.city||"",lagosTime(r.createdAt)]);
    }
    csvDownload("users.csv", rows);
  };

  [fProject,fEmail,fIP].forEach(i=>i.addEventListener("input",renderFeedback));
  clearF.onclick = ()=>{ fProject.value=fEmail.value=fIP.value=""; renderFeedback(); };

  [vPage,vIP,vISP,vCity].forEach(i=>i.addEventListener("input",renderVisitors));
  clearV.onclick = ()=>{ vPage.value=vIP.value=vISP.value=vCity.value=""; renderVisitors(); };

  [uEmail,uIP,uISP,uCity].forEach(i=>i.addEventListener("input",renderUsers));
  clearU.onclick = ()=>{ uEmail.value=uIP.value=uISP.value=uCity.value=""; ren
