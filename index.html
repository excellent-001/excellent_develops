<!-- Add this inside .form-box, above the form or below the button -->
<div id="loadingSpinner" style="display:none; text-align:center; margin:10px 0;">
  <div style="border:4px solid #f3f3f3; border-top:4px solid #6a11cb; border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; margin:auto;"></div>
</div>

<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import "https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js";

const firebaseConfig = {
  apiKey: "AIzaSyDoTlLIlOyoYiTZLQmzVcDro-cw9TCU9qI",
  authDomain: "excellent-d056e.firebaseapp.com",
  projectId: "excellent-d056e",
  storageBucket: "excellent-d056e.appspot.com",
  messagingSenderId: "629984941607",
  appId: "1:629984941607:web:3d7fc2478f555d45a0e002",
  measurementId: "G-G3RCTDSY27"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

emailjs.init("h5LWzY8YUESb4sZbS");
const EMAIL_SERVICE = "service_r556h12";
const EMAIL_TEMPLATE = "template_6xgms6a";
const ADMIN_EMAIL = "quareebalabi22@gmail.com";

document.getElementById("loginForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const spinner = document.getElementById("loadingSpinner");
  spinner.style.display = "block";  // show spinner

  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;

  console.log("Login attempt:", email);

  try {
    // Firebase login
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    console.log("Firebase login success:", user.uid);

    // Firestore user document
    let userName = "User";
    try {
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if(userDoc.exists()) {
        userName = userDoc.data().fullname || "User";
      }
      console.log("User doc fetched:", userName);
    } catch(fireErr) {
      console.error("Firestore error:", fireErr);
    }

    // Admin two-way login
    if(email.toLowerCase() === ADMIN_EMAIL){
      const choice = confirm("Do you want to login as Admin? Click OK for Admin, Cancel for User.");
      if(choice){
        const code = prompt("Enter Admin Secret Code:");
        if(code === "excellentAdmin2025"){
          window.location.href = "admin-dashboard.html";
          return;
        } else {
          alert("Invalid secret code. Logging in as regular user instead.");
        }
      }
    }

    // EmailJS notification
    try {
      await emailjs.send(EMAIL_SERVICE, EMAIL_TEMPLATE, {
        from_email: ADMIN_EMAIL,
        from_name: "Excellent_Develops",
        to_email: email,
        to_name: userName,
        message: `Hi ${userName},\n\nYou successfully logged in to Excellent Developers!`
      });
      console.log("EmailJS sent successfully");
    } catch(emailErr) {
      console.error("EmailJS error:", emailErr);
    }

    // Redirect to welcome page
    window.location.href = "welcome.html";

  } catch (error) {
    console.error("Login error:", error);
    alert("Login failed: " + error.message);
  } finally {
    spinner.style.display = "none"; // hide spinner
  }
});
</script>
