<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const SECRET_CODE = "554455"; 

  const firebaseConfig = {
    apiKey: "AIzaSyDoTlLIlOyoYiTZLQmzVcDro-cw9TCU9qI",
    authDomain: "excellent-d056e.firebaseapp.com",
    projectId: "excellent-d056e",
    storageBucket: "excellent-d056e.firebasestorage.app",
    messagingSenderId: "629984941607",
    appId: "1:629984941607:web:3d7fc2478f555d45a0e002",
    measurementId: "G-G3RCTDSY27"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const userEmailEl = document.getElementById("email");
  const userPassEl = document.getElementById("pass");
  const userLoginBtn = document.getElementById("userLoginBtn");
  const userMsg = document.getElementById("userMsg");

  const adminTeaser = document.getElementById("adminTeaser");
  const adminCard = document.getElementById("adminCard");
  const showAdminBtn = document.getElementById("showAdminBtn");
  const hideAdminBtn = document.getElementById("hideAdminBtn");
  const adminEmailEl = document.getElementById("adminEmail");
  const adminPassEl = document.getElementById("adminPass");
  const adminLoginBtn = document.getElementById("adminLoginBtn");
  const adminMsg = document.getElementById("adminMsg");

  const params = new URLSearchParams(location.search);
  const hasSecret = params.get("code") === SECRET_CODE;

  if (hasSecret) {
    adminTeaser.classList.remove("hidden");
  }

  showAdminBtn?.addEventListener("click", ()=>{
    adminCard.classList.remove("hidden");
    adminTeaser.classList.add("hidden");
    adminEmailEl.focus();
  });

  hideAdminBtn?.addEventListener("click", ()=>{
    adminCard.classList.add("hidden");
    adminTeaser.classList.remove("hidden");
  });

  // ✅ USER LOGIN
  userLoginBtn.addEventListener("click", async ()=>{
    userMsg.textContent = "";
    const email = userEmailEl.value.trim();
    const pass = userPassEl.value;
    if (!email || !pass) {
      userMsg.textContent = "Enter email and password.";
      return;
    }
    try{
      await signInWithEmailAndPassword(auth, email, pass);

      // check if this user is admin
      const snap = await getDoc(doc(db,"admins", email.toLowerCase()));
      if (snap.exists()) {
        // give choice if admin
        window.location.href = "redirect-choice.html";
      } else {
        userMsg.textContent = "Success. Redirecting…";
        window.location.href = "welcome.html";
      }

    } catch(e){
      userMsg.textContent = "Error: " + (e?.message || e);
    }
  });

  // ✅ ADMIN LOGIN
  adminLoginBtn.addEventListener("click", async ()=>{
    adminMsg.textContent = "";
    if (!hasSecret) {
      adminMsg.textContent = "Missing admin link. Ask owner for secure link.";
      return;
    }
    const email = adminEmailEl.value.trim().toLowerCase();
    const pass = adminPassEl.value;
    if (!email || !pass) {
      adminMsg.textContent = "Enter admin email and password.";
      return;
    }
    try{
      await signInWithEmailAndPassword(auth, email, pass);
      const snap = await getDoc(doc(db, "admins", email));
      if (!snap.exists()) {
        try{ await signOut(auth); }catch{}
        adminMsg.textContent = "This account is not an admin.";
        return;
      }
      adminMsg.textContent = "Admin verified. Redirecting…";
      window.location.href = "redirect-choice.html"; // ✅ new choice page
    } catch(e){
      adminMsg.textContent = "Error: " + (e?.message || e);
    }
  });

</script>
